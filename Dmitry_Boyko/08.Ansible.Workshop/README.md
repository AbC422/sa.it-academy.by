### 08.Ansible.Workshop

# Source redmine.yaml

```yaml
- hosts: redmine
  pre_tasks:
  - debug:
      msg: "{{ ansible_host }}"

  - name: Include pre_tasks variables
    include_vars: "vars.yaml"

  - name: Redmine. Install packages
    apt:
      name: "{{ apt_redmine_packages }}"
      state: latest
      update_cache: yes
      force_apt_get: yes

  roles:
    - mysql
    - redmine

  post_tasks:
  - name: Include post_tasks variables
    include_vars: "vars.yaml"
    tags:
      - test

  - name: "Add {{ app_fqdn }} to host file"
    shell: echo "127.0.0.1       {{ app_fqdn }}" >> /etc/hosts
    tags:
     - test

  - uri:
      url: "http://{{ app_fqdn }}"
      return_content: yes
    register: this
    failed_when: "'Jean-Philippe Lang' not in this.content"
    tags:
      - test

  - lineinfile:
      path: /etc/hosts
      state: absent
      regexp: '^127.0.0.1       {{ app_fqdn }}'
    tags:
      - test
      - always
```

# Console output result

```yaml
ansible-playbook  -i inv.yaml redmine.yaml

PLAY [redmine] *********************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] *************************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:17:56 +0300 (0:00:00.011)       0:00:00.011 *****
ok: [redmine]

TASK [debug] ***********************************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:17:57 +0300 (0:00:01.673)       0:00:01.685 *****
ok: [redmine] => {
    "msg": "192.168.201.1"
}

TASK [Include pre_tasks variables] *************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:17:57 +0300 (0:00:00.031)       0:00:01.716 *****
ok: [redmine]

TASK [Redmine. Install packages] ***************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:17:57 +0300 (0:00:00.025)       0:00:01.742 *****
ok: [redmine]

TASK [mysql : mysql_db] ************************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:17:59 +0300 (0:00:01.889)       0:00:03.631 *****
ok: [redmine]

TASK [mysql : mysql_user] **********************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:00 +0300 (0:00:00.796)       0:00:04.427 *****
ok: [redmine]

TASK [redmine : Redmine. Clone repository] *****************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:01 +0300 (0:00:00.822)       0:00:05.250 *****
changed: [redmine]

TASK [redmine : Redmine. Change permissions] ***************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:04 +0300 (0:00:02.912)       0:00:08.163 *****
ok: [redmine]

TASK [redmine : Redmine. Change permissions] ***************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:05 +0300 (0:00:00.792)       0:00:08.955 *****
ok: [redmine]

TASK [redmine : Config database] ***************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:05 +0300 (0:00:00.638)       0:00:09.593 *****
ok: [redmine]

TASK [redmine : Redmine. Setup 01] *************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:07 +0300 (0:00:01.357)       0:00:10.951 *****
changed: [redmine]

TASK [redmine : Session store secret generation] ***********************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:12 +0300 (0:00:05.557)       0:00:16.509 *****
ok: [redmine]

TASK [redmine : Redmine. Setup 02] *************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:13 +0300 (0:00:00.660)       0:00:17.169 *****
changed: [redmine]

TASK [redmine : Redmine. Change permissions] ***************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:23 +0300 (0:00:10.577)       0:00:27.747 *****
changed: [redmine]

TASK [redmine : Configuration files for virtualhost] *******************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:24 +0300 (0:00:00.683)       0:00:28.431 *****
ok: [redmine]

TASK [redmine : meta] **************************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:25 +0300 (0:00:01.095)       0:00:29.527 *****

TASK [Include post_tasks variables] ************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:25 +0300 (0:00:00.027)       0:00:29.554 *****
ok: [redmine]

TASK [Add redmine-1.sa to host file] ***********************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:25 +0300 (0:00:00.031)       0:00:29.586 *****
changed: [redmine]

TASK [uri] *************************************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:26 +0300 (0:00:00.651)       0:00:30.238 *****
ok: [redmine]

TASK [lineinfile] ******************************************************************************************************************************************************************************************************************************************
Saturday 05 February 2022  17:18:27 +0300 (0:00:00.873)       0:00:31.111 *****
changed: [redmine]

PLAY RECAP *************************************************************************************************************************************************************************************************************************************************
redmine                    : ok=19   changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

Saturday 05 February 2022  17:18:28 +0300 (0:00:00.758)       0:00:31.870 *****
===============================================================================
redmine : Redmine. Setup 02 ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 10.58s
redmine : Redmine. Setup 01 ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 5.56s
redmine : Redmine. Clone repository ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 2.91s
Redmine. Install packages --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.89s
Gathering Facts ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.67s
redmine : Config database --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.36s
redmine : Configuration files for virtualhost ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 1.10s
uri ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.87s
mysql : mysql_user ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.82s
mysql : mysql_db ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 0.80s
redmine : Redmine. Change permissions --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.79s
lineinfile ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 0.76s
redmine : Redmine. Change permissions --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.68s
redmine : Session store secret generation ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.66s
Add redmine-1.sa to host file ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.65s
redmine : Redmine. Change permissions --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.64s
Include post_tasks variables ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ 0.03s
debug ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.03s
redmine : meta -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.03s
Include pre_tasks variables ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.03s
Playbook run took 0 days, 0 hours, 0 minutes, 31 seconds
```
