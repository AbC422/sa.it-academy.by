## 19.Jenkins.DockerandPod

+ ### Jenkinsfile

```groovy
pipeline {
  agent {
    kubernetes {
        containerTemplate {
        name 'kubeval'
        image 'garethr/kubeval:latest'
        ttyEnabled true
        command 'watch date'
        }
    }
  }
  stages {
    stage('Clone repository') { 
        steps { 
                git branch: 'main', url: 'https://github.com/astarosh87/my_repo.git'
        }
    }
    stage('Run kubeval in parallel') {
        parallel {
            stage('Check grafana.yaml') {
                steps {
                    container('kubeval') {
                      sh """#!/bin/sh
                        kubeval yamls/grafana.yaml
                        
                    """
                    }
                }
            }
            stage('Check prometheus.yaml') {
                steps {
                    container('kubeval') {
                      sh """#!/bin/sh
                        kubeval yamls/prometheus.yaml
                        
                    """
                    }
                }
            }
        }
    }
  }
  post {
        success {
                slackSend (color: 'good', message: "GOOD: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
        }
            failure {
                slackSend (color: 'danger', message: "BAD: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})")
        }
    }
}
```
---
+ ###  Slack notification
![image](https://raw.githubusercontent.com/astarosh87/sa.it-academy.by/md-sa2-17-21/vsinyavski/19.Jenkins.DockerandPod/Slack_Jenkins.png)

---

+ ### Output console

```
Started by user admin
Running in Durability level: MAX_SURVIVABILITY
[Pipeline] Start of Pipeline
[Pipeline] echo
[WARNING] containerTemplate option is deprecated, use yaml syntax to define containers.
[Pipeline] podTemplate
[Pipeline] {
[Pipeline] node
Created Pod: kubernetes vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Scheduled] Successfully assigned vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp to node2
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Pulled] Container image "garethr/kubeval:latest" already present on machine
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Created] Created container kubeval
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Started] Started container kubeval
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Pulled] Container image "jenkins/inbound-agent:4.3-4" already present on machine
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Created] Created container jnlp
[Normal][vit-ci-cd/19-hw-task-13-5z1pd-f2hvz-sd0zp][Started] Started container jnlp
Agent 19-hw-task-13-5z1pd-f2hvz-sd0zp is provisioned from template 19_HW_Task_13-5z1pd-f2hvz
---
apiVersion: "v1"
kind: "Pod"
metadata:
  annotations:
    buildUrl: "http://jenkins:8080/job/19.HW.Task/13/"
    runUrl: "job/19.HW.Task/13/"
  labels:
    jenkins: "slave"
    jenkins/label-digest: "f369410092daf1f4b2a8ec3eae3c81ae36de6b13"
    jenkins/label: "19_HW_Task_13-5z1pd"
  name: "19-hw-task-13-5z1pd-f2hvz-sd0zp"
spec:
  containers:
  - command:
    - "watch"
    - "date"
    image: "garethr/kubeval:latest"
    imagePullPolicy: "IfNotPresent"
    name: "kubeval"
    resources:
      limits: {}
      requests: {}
    tty: true
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"
      readOnly: false
  - env:
    - name: "JENKINS_SECRET"
      value: "********"
    - name: "JENKINS_AGENT_NAME"
      value: "19-hw-task-13-5z1pd-f2hvz-sd0zp"
    - name: "JENKINS_NAME"
      value: "19-hw-task-13-5z1pd-f2hvz-sd0zp"
    - name: "JENKINS_AGENT_WORKDIR"
      value: "/home/jenkins/agent"
    - name: "JENKINS_URL"
      value: "http://jenkins:8080/"
    image: "jenkins/inbound-agent:4.3-4"
    name: "jnlp"
    resources:
      limits: {}
      requests:
        memory: "256Mi"
        cpu: "100m"
    volumeMounts:
    - mountPath: "/home/jenkins/agent"
      name: "workspace-volume"
      readOnly: false
  nodeSelector:
    kubernetes.io/os: "linux"
  restartPolicy: "Never"
  volumes:
  - emptyDir:
      medium: ""
    name: "workspace-volume"

Running on 19-hw-task-13-5z1pd-f2hvz-sd0zp in /home/jenkins/agent/workspace/19.HW.Task
[Pipeline] {
[Pipeline] container
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Clone repository)
[Pipeline] git
The recommended git tool is: git
No credentials specified
Warning: JENKINS-30600: special launcher org.csanchez.jenkins.plugins.kubernetes.pipeline.ContainerExecDecorator$1@292334e8; decorates RemoteLauncher[hudson.remoting.Channel@3038a926:JNLP4-connect connection from 10.233.96.175/10.233.96.175:46944] will be ignored (a typical symptom is the Git executable not being run inside a designated container)
Cloning the remote Git repository
Cloning repository https://github.com/astarosh87/my_repo.git
 > git init /home/jenkins/agent/workspace/19.HW.Task # timeout=10
Fetching upstream changes from https://github.com/astarosh87/my_repo.git
 > git --version # timeout=10
 > git --version # 'git version 2.20.1'
 > git fetch --tags --force --progress -- https://github.com/astarosh87/my_repo.git +refs/heads/*:refs/remotes/origin/* # timeout=10
Avoid second fetch
Checking out Revision 2a52f3e12367425ea21a980d7a5bac42e691cade (refs/remotes/origin/main)
 > git config remote.origin.url https://github.com/astarosh87/my_repo.git # timeout=10
 > git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/main^{commit} # timeout=10
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 2a52f3e12367425ea21a980d7a5bac42e691cade # timeout=10
 > git branch -a -v --no-abbrev # timeout=10
 > git checkout -b main 2a52f3e12367425ea21a980d7a5bac42e691cade # timeout=10
Commit message: "19.HW.Jenkinsfile"
 > git rev-list --no-walk 2a52f3e12367425ea21a980d7a5bac42e691cade # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Run kubeval in parallel)
[Pipeline] parallel
[Pipeline] { (Branch: Check grafana.yaml)
[Pipeline] { (Branch: Check prometheus.yaml)
[Pipeline] stage
[Pipeline] { (Check grafana.yaml)
[Pipeline] stage
[Pipeline] { (Check prometheus.yaml)
[Pipeline] container
[Pipeline] {
[Pipeline] container
[Pipeline] {
[Pipeline] sh
[Pipeline] sh
PASS - yamls/grafana.yaml contains a valid ConfigMap (monitoring.grafana-datasources)
PASS - yamls/grafana.yaml contains a valid Deployment (monitoring.grafana)
PASS - yamls/grafana.yaml contains a valid Service (monitoring.grafana)
PASS - yamls/grafana.yaml contains a valid Ingress (monitoring.grafana-ingres)
[Pipeline] }
[Pipeline] // container
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
PASS - yamls/prometheus.yaml contains a valid ClusterRole (prometheus)
PASS - yamls/prometheus.yaml contains a valid ClusterRoleBinding (prometheus)
PASS - yamls/prometheus.yaml contains a valid ConfigMap (monitoring.prometheus-server-conf)
PASS - yamls/prometheus.yaml contains a valid Deployment (monitoring.prometheus-deployment)
PASS - yamls/prometheus.yaml contains a valid Service (monitoring.prometheus-service)
PASS - yamls/prometheus.yaml contains a valid Ingress (monitoring.prometheus-ingres)
[Pipeline] }
[Pipeline] // container
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // parallel
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Declarative: Post Actions)
[Pipeline] slackSend
Slack Send Pipeline step running, values are - baseUrl: <empty>, teamDomain: sa-itacademy-by, channel: #ansible_channel, color: good, botUser: false, tokenCredentialId: da922926-f0e6-4f09-b29c-53ead840fae3, notifyCommitters: false, iconEmoji: <empty>, username: <empty>, timestamp: <empty>
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // container
[Pipeline] }
[Pipeline] // node
[Pipeline] }
[Pipeline] // podTemplate
[Pipeline] End of Pipeline
Finished: SUCCESS
```